<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1,user-scalable=no"/>
<title>Thiá»‡p 20/10 â€“ HÃ nh TrÃ¬nh Ná»Ÿ Hoa ğŸŒ¸</title>
<link href="https://fonts.googleapis.com/css2?family=Mali:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  :root{
    --rose:#d81b60;
    --rose-2:#f06292;
    --bg1:#fff0f5;
    --bg2:#ffeaf0;
  }
  body{
    font-family:"Mali",cursive;
    background:linear-gradient(135deg,var(--bg1),var(--bg2));
    height:100vh; overflow:hidden; color:var(--rose);
  }
  button{cursor:pointer; border:none; outline:none}
  .hidden{display:none !important;}
  .center{
    position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
    background:rgba(255,255,255,.86); border-radius:28px; padding:28px 32px;
    text-align:center; box-shadow:0 20px 60px rgba(216,27,96,.28);
    backdrop-filter:saturate(1.1) blur(6px); width:min(92vw,720px);
  }
  .title{
    font-weight:700; font-size:2rem;
    background:linear-gradient(45deg,var(--rose),var(--rose-2));
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    margin-bottom:8px;
  }
  .desc{font-size:1.1rem; line-height:1.65}
  .btn{
    margin-top:18px; padding:12px 22px; border-radius:28px; color:#fff;
    background:linear-gradient(135deg,var(--rose),var(--rose-2));
    font-weight:700; box-shadow:0 8px 24px rgba(216,27,96,.32);
    transition:.25s transform; display:inline-flex; align-items:center; gap:.5rem;
  }
  .btn:hover{transform:translateY(-1px) scale(1.02)}
  .btn-outline{
    background:#fff; color:var(--rose); border:2px solid var(--rose-2);
  }
  .fade-in{animation:fadeIn .6s ease forwards}
  @keyframes fadeIn{from{opacity:0; transform:translate(-50%,-48%)}to{opacity:1; transform:translate(-50%,-50%)}}

  /* Stage 2 falling */
  .falling{
    position:absolute; top:-80px; width:54px; user-select:none;
    animation:fall 9s linear forwards; filter:drop-shadow(0 6px 10px rgba(0,0,0,.18));
  }
  @keyframes fall{
    0%{transform:translateY(-10vh) rotate(0deg); opacity:1}
    100%{transform:translateY(110vh) rotate(360deg); opacity:.15}
  }
  /* Popup */
  .popup{
    position:fixed; top:50%; left:50%; transform:translate(-50%,-50%) scale(.85);
    background:#fff; border-radius:24px; padding:20px; width:min(90vw,420px);
    text-align:center; box-shadow:0 20px 70px rgba(216,27,96,.4); z-index:20;
    opacity:0; pointer-events:none; transition:.3s ease;
  }
  .popup.active{opacity:1; transform:translate(-50%,-50%) scale(1); pointer-events:auto}
  .popup img{width:100%; border-radius:18px; margin-bottom:12px}
  .popup p{line-height:1.6; font-weight:600}
  /* Hearts */
  .heart{
    position:absolute; pointer-events:none;
    animation:burst 1.5s ease-out forwards; font-size:20px;
  }
  @keyframes burst{
    0%{transform:translate(-50%,-50%) scale(.55); opacity:1}
    100%{transform:translate(var(--dx),var(--dy)) scale(1.9); opacity:0}
  }
  /* Fireworks */
  .fw{
    position:fixed; width:6px; height:6px; border-radius:50%; background:#ff80ab;
    animation:fw 1.2s ease-out forwards; pointer-events:none;
  }
  @keyframes fw{
    from{transform:translate(0,0) scale(1); opacity:1}
    to{transform:translate(var(--x),var(--y)) scale(0); opacity:0}
  }
  /* Gift box (stage 6) */
  .gift-wrap{
    display:flex; align-items:center; justify-content:center; gap:14px; margin-top:14px;
  }
  .gift{
    width:120px; height:120px; border-radius:16px; background:#ffe2ec;
    display:flex; align-items:center; justify-content:center;
    box-shadow:0 16px 40px rgba(216,27,96,.25); position:relative; overflow:hidden;
  }
  .ribbon{
    position:absolute; width:20px; height:100%; background:var(--rose); left:calc(50% - 10px);
  }
  .ribbon:before{
    content:""; position:absolute; top:calc(50% - 10px); left:-50px; right:-50px; height:20px; background:var(--rose);
  }
  .gift:hover{transform:translateY(-2px)}
  .box-lid{
    position:absolute; top:-4px; left:8px; right:8px; height:22px; border-radius:12px;
    background:linear-gradient(45deg,#ffc2d6,#ffa3c5);
  }
  .sparkle{position:absolute; width:6px; height:6px; border-radius:50%; background:#fff; opacity:.8; animation:sp 1.8s ease-out infinite}
  @keyframes sp{from{transform:translateY(0) scale(.6)}to{transform:translateY(-26px) scale(1.2); opacity:0}}
  /* Stage stepper */
  .stepper{position:fixed; top:12px; left:50%; transform:translateX(-50%); display:flex; gap:8px; z-index:9}
  .dot{width:10px; height:10px; border-radius:999px; background:#ffd1e2; opacity:.65}
  .dot.active{background:var(--rose); opacity:1}
  /* Input wish (stage 7) */
  .wish-box{margin-top:14px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap}
  .wish-box textarea{
    width:min(86vw,520px); height:90px; padding:10px 12px; border-radius:14px; border:2px solid #ffd1e2;
    outline:none; font-family:"Mali",cursive; color:var(--rose)
  }
  .sky{
    position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:0;
  }
  .float-text{
    position:absolute; left:50%; transform:translateX(-50%);
    color:var(--rose); font-weight:700; opacity:0; animation:floatUp 6s ease forwards;
    text-shadow:0 2px 0 #fff;
  }
  @keyframes floatUp{0%{bottom:-20px; opacity:0}20%{opacity:1}100%{bottom:84%; opacity:0}}
  /* Tooltip/hint */
  .hint{
    position:fixed; top:14px; left:50%; transform:translateX(-50%);
    background:#fff; padding:8px 16px; border-radius:20px; box-shadow:0 8px 24px rgba(216,27,96,.2);
    z-index:8; opacity:0; animation:hint 7s ease forwards; color:var(--rose); font-weight:600
  }
  @keyframes hint{
    0%{opacity:0; transform:translate(-50%,-6px)} 10%,75%{opacity:1; transform:translate(-50%,0)} 100%{opacity:0; transform:translate(-50%,-6px)}
  }
  /* Responsive */
  @media (max-width:768px){
    .title{font-size:1.5rem}
    .desc{font-size:1.02rem}
    .gift{width:104px; height:104px}
  }
</style>
</head>
<body>

<!-- Floating sky for stage 7 text -->
<div class="sky" id="sky"></div>

<!-- Stepper -->
<div class="stepper" id="stepper"></div>
<div class="hint">ğŸŒ¸ HÆ°á»›ng dáº«n: LÃ m theo nÃºt trÃªn mÃ n hÃ¬nh & cháº¡m vÃ o quÃ  Ä‘á»ƒ khÃ¡m phÃ¡!</div>

<!-- Stage 1 â€“ Khá»Ÿi Ä‘áº§u -->
<section id="stage1" class="center fade-in">
  <div class="title">ChÃºc má»«ng 20/10</div>
  <p class="desc">Má»™t ngÃ y má»›i báº¯t Ä‘áº§u â€“ ngÃ y dÃ nh riÃªng cho báº¡n. CÃ¹ng bÆ°á»›c vÃ o hÃ nh trÃ¬nh ná»Ÿ hoa nhÃ©! ğŸ’Œ</p>
  <button class="btn" id="btnStart">Báº¯t Ä‘áº§u hÃ nh trÃ¬nh</button>
</section>

<!-- Stage 2 â€“ CÆ¡n mÆ°a quÃ  rÆ¡i -->
<section id="stage2" class="center hidden">
  <div class="title">CÆ¡n mÆ°a yÃªu thÆ°Æ¡ng ğŸŒ¸</div>
  <p class="desc">Cháº¡m vÃ o nhá»¯ng mÃ³n quÃ  rÆ¡i xuá»‘ng Ä‘á»ƒ nháº­n lá»i chÃºc Ä‘áº§u tiÃªn (báº¯t 3 mÃ³n)!</p>
</section>

<!-- Popup lá»i chÃºc (Stage 3) -->
<div id="popup" class="popup">
  <img id="popupImg" alt="gift"/>
  <p id="popupText"></p>
  <button class="btn" id="btnPopupNext">Tiáº¿p tá»¥c ğŸŒº</button>
</div>

<!-- Stage 4 â€“ PhÃ¡o hoa cáº£m Æ¡n -->
<section id="stage4" class="center hidden">
  <div class="title">ğŸŒº Cáº£m Æ¡n báº¡n ğŸŒº</div>
  <p class="desc">VÃ¬ Ä‘Ã£ mang Ä‘áº¿n tháº¿ giá»›i nÃ y sá»± dá»‹u dÃ ng, máº¡nh máº½ vÃ  yÃªu thÆ°Æ¡ng. HÃ£y Ä‘Ã³n nháº­n Ä‘iá»u báº¥t ngá» tiáº¿p theo!</p>
  <button class="btn" id="btnToBox">Má»Ÿ há»™p quÃ  bÃ­ máº­t ğŸ</button>
</section>

<!-- Stage 6 â€“ Há»™p quÃ  bÃ­ máº­t -->
<section id="stage6" class="center hidden">
  <div class="title">Há»™p quÃ  bÃ­ máº­t ğŸ</div>
  <p class="desc">Click vÃ o má»™t trong ba há»™p quÃ  Ä‘á»ƒ má»Ÿ. BÃªn trong lÃ  Ä‘iá»u xinh xáº¯n dÃ nh cho báº¡n!</p>
  <div class="gift-wrap" id="giftWrap">
    <div class="gift" data-i="0"><div class="box-lid"></div><div class="ribbon"></div></div>
    <div class="gift" data-i="1"><div class="box-lid"></div><div class="ribbon"></div></div>
    <div class="gift" data-i="2"><div class="box-lid"></div><div class="ribbon"></div></div>
  </div>
  <button class="btn" id="btnToWrite">Viáº¿t lá»i chÃºc cá»§a báº¡n âœï¸</button>
</section>

<!-- Stage 7 â€“ Viáº¿t lá»i chÃºc -->
<section id="stage7" class="center hidden">
  <div class="title">Viáº¿t lá»i chÃºc</div>
  <p class="desc">Gá»­i má»™t lá»i nháº¯n ngáº¯n gá»n Ä‘áº¿n chÃ­nh báº¡n hoáº·c ai Ä‘Ã³ mÃ  báº¡n trÃ¢n trá»ng. Lá»i chÃºc sáº½ bay lÃªn báº§u trá»i! âœ¨</p>
  <div class="wish-box">
    <textarea id="wishInput" placeholder="VÃ­ dá»¥: ChÃºc báº¡n luÃ´n bÃ¬nh an vÃ  rá»±c rá»¡ nhÆ° hÃ´m nay!"></textarea>
    <button class="btn" id="btnWish">Tháº£ lá»i chÃºc lÃªn trá»i ğŸ’–</button>
  </div>
  <button class="btn btn-outline" id="btnToEnd">Káº¿t thÃºc hÃ nh trÃ¬nh ğŸŒ·</button>
</section>

<!-- Stage 8 â€“ Lá»i káº¿t & chia sáº» -->
<section id="stage8" class="center hidden">
  <div class="title">ğŸ’ ChÃºc má»«ng 20/10 ğŸ’</div>
  <p class="desc" id="endDesc">Má»—i bÃ´ng hoa Ä‘á»u Ä‘áº¹p theo cÃ¡ch riÃªng. VÃ  báº¡n cÅ©ng tháº¿. HÃ£y lan tá»a yÃªu thÆ°Æ¡ng nhÃ©!</p>
  <div style="display:flex;gap:10px; justify-content:center; flex-wrap:wrap; margin-top:10px">
    <button class="btn" id="btnShare">ğŸ“¤ Chia sáº» thiá»‡p</button>
    <button class="btn btn-outline" id="btnReplay">ğŸ” ChÆ¡i láº¡i hÃ nh trÃ¬nh</button>
  </div>
</section>

<!-- Audio -->
<audio id="bgm" src="./assets/a.mp3" preload="auto"></audio>

<script>
  // ---------- Config ----------
  const ASSETS = {
    gifts: ["./assets/a1.jpg","./assets/a2.jpg","./assets/a3.jpg","./assets/a4.jpg"],
    messages: [
      "ChÃºc báº¡n luÃ´n xinh Ä‘áº¹p vÃ  ngáº­p trÃ n yÃªu thÆ°Æ¡ng ğŸ’",
      "HÃ´m nay, má»i Ã¡nh sÃ¡ng Ä‘á»u thuá»™c vá» báº¡n âœ¨",
      "Cáº£m Æ¡n báº¡n vÃ¬ Ä‘Ã£ mang Ä‘iá»u tá»‘t Ä‘áº¹p Ä‘áº¿n tháº¿ giá»›i nÃ y ğŸ’–",
      "Báº¡n chÃ­nh lÃ  Ä‘oÃ¡ hoa Ä‘áº¹p nháº¥t cá»§a ngÃ y hÃ´m nay ğŸŒ¸"
    ]
  };

  // ---------- State ----------
  let stage = 1;
  let catched = 0;         // cáº§n báº¯t 3 mÃ³n á»Ÿ stage 2
  let msgIndex = 0;

  // ---------- Elements ----------
  const el = (id)=>document.getElementById(id);
  const E = {
    stepper: el("stepper"),
    popup: el("popup"),
    popupImg: el("popupImg"),
    popupText: el("popupText"),
    btnPopupNext: el("btnPopupNext"),
    stage1: el("stage1"),
    stage2: el("stage2"),
    stage4: el("stage4"),
    stage6: el("stage6"),
    stage7: el("stage7"),
    stage8: el("stage8"),
    btnStart: el("btnStart"),
    btnToBox: el("btnToBox"),
    btnToWrite: el("btnToWrite"),
    btnWish: el("btnWish"),
    btnToEnd: el("btnToEnd"),
    btnShare: el("btnShare"),
    btnReplay: el("btnReplay"),
    bgm: el("bgm"),
    wishInput: el("wishInput"),
    giftWrap: el("giftWrap"),
    sky: el("sky"),
    endDesc: el("endDesc")
  };

  // ---------- Helpers ----------
  function showStage(n){
    stage = n;
    [1,2,4,6,7,8].forEach(s=>{
      const node = el("stage"+s);
      if(!node) return;
      if(s===n) node.classList.remove("hidden"); else node.classList.add("hidden");
    });
    // popup off when switching
    E.popup.classList.remove("active");
    renderStepper(n);
  }

  function renderStepper(n){
    const total = 8;
    E.stepper.innerHTML = "";
    for (let i=1;i<=total;i++){
      const d = document.createElement("div");
      d.className = "dot"+(i<=n?" active":"");
      E.stepper.appendChild(d);
    }
  }

  function heartBurst(x,y,count=10){
    for(let i=0;i<count;i++){
      const h = document.createElement("div");
      h.className = "heart"; h.textContent = "ğŸ’–";
      const a = Math.random()*Math.PI*2;
      const d = 60 + Math.random()*80;
      h.style.left = x+"px";
      h.style.top = y+"px";
      h.style.setProperty("--dx", Math.cos(a)*d + "px");
      h.style.setProperty("--dy", Math.sin(a)*d + "px");
      document.body.appendChild(h);
      setTimeout(()=>h.remove(),1500);
    }
  }

  function fireworks(times=46){
    for(let i=0;i<times;i++){
      const f = document.createElement("div");
      f.className="fw";
      const cx = window.innerWidth/2, cy=window.innerHeight/2;
      f.style.left = cx+"px"; f.style.top = cy+"px";
      const a = Math.random()*Math.PI*2;
      const dist = 110 + Math.random()*220;
      f.style.setProperty("--x", Math.cos(a)*dist+"px");
      f.style.setProperty("--y", Math.sin(a)*dist+"px");
      document.body.appendChild(f);
      setTimeout(()=>f.remove(),1200);
    }
  }

  // random falling item
  function spawnFalling(){
    if(stage!==2) return;
    const img = document.createElement("img");
    img.src = ASSETS.gifts[Math.floor(Math.random()*ASSETS.gifts.length)];
    img.className = "falling";
    img.style.left = (Math.random()*(window.innerWidth-70))+"px";
    img.addEventListener("click", e=>{
      img.remove();
      catched++;
      heartBurst(e.clientX, e.clientY, 12);
      showPopup();
      if(catched>=3){
        // sáº½ chuyá»ƒn stage á»Ÿ nÃºt popup
      }
    });
    document.body.appendChild(img);
    setTimeout(()=>img.remove(),9000);
  }

  let dropTimer=null;
  function startRain(){
    catched = 0;
    spawnFalling();
    dropTimer = setInterval(spawnFalling, 1200);
  }
  function stopRain(){
    if(dropTimer) clearInterval(dropTimer);
    dropTimer = null;
  }

  function showPopup(){
    E.popupImg.src = ASSETS.gifts[msgIndex % ASSETS.gifts.length];
    E.popupText.innerHTML = ASSETS.messages[msgIndex % ASSETS.messages.length];
    msgIndex++;
    E.popup.classList.add("active");
  }

  function saveWishToSky(text){
    if(!text.trim()) return;
    localStorage.setItem("my_2010_wish", text.trim());
    const t = document.createElement("div");
    t.className="float-text";
    t.style.fontSize = (16 + Math.random()*8) + "px";
    t.style.left = (30 + Math.random()*40) + "%";
    t.textContent = "â€œ " + text.trim() + " â€";
    E.sky.appendChild(t);
    setTimeout(()=>t.remove(), 6000);
  }

  // ---------- Stage wiring ----------
  // Stage 1 -> 2
  E.btnStart.addEventListener("click", ()=>{
    // start music on first interaction
    if(E.bgm.paused){ try{ E.bgm.play(); }catch{} }
    showStage(2);
    startRain();
  });

  // Popup next (from stage 3)
  E.btnPopupNext.addEventListener("click", ()=>{
    E.popup.classList.remove("active");
    if(stage===2 && catched>=3){
      stopRain();
      showStage(4);
      fireworks();
    }
  });

  // Stage 4 -> 6
  E.btnToBox.addEventListener("click", ()=>{
    showStage(6);
    // add sparkles on gifts
    [...E.giftWrap.querySelectorAll(".gift")].forEach(g=>{
      for(let i=0;i<4;i++){
        const s=document.createElement("div");
        s.className="sparkle";
        s.style.left = (20 + Math.random()*80) + "px";
        s.style.top = (60 + Math.random()*30) + "px";
        s.style.animationDelay = (Math.random()*1)+"s";
        g.appendChild(s);
      }
    });
  });

  // Stage 6 gift open
  E.giftWrap.addEventListener("click", (e)=>{
    const box = e.target.closest(".gift");
    if(!box) return;
    // lid animation
    const lid = box.querySelector(".box-lid");
    lid.style.transition="transform .4s ease";
    lid.style.transform="translateY(-46px) rotate(-6deg)";
    // burst
    const rect = box.getBoundingClientRect();
    heartBurst(rect.left+rect.width/2, rect.top+rect.height/2, 14);
  });

  // Stage 6 -> 7
  E.btnToWrite.addEventListener("click", ()=> showStage(7));

  // Stage 7: write wish to sky
  E.btnWish.addEventListener("click", ()=>{
    const text = E.wishInput.value || "ChÃºc báº¡n luÃ´n bÃ¬nh an vÃ  rá»±c rá»¡!";
    saveWishToSky(text);
    E.wishInput.value="";
  });

  // Stage 7 -> 8
  E.btnToEnd.addEventListener("click", ()=>{
    const saved = localStorage.getItem("my_2010_wish");
    showStage(8);
    if(saved){
      E.endDesc.innerHTML = "Lá»i chÃºc cá»§a báº¡n: <b>â€œ"+ saved +"â€</b><br/>HÃ£y lan tá»a yÃªu thÆ°Æ¡ng nhÃ©!";
    }
  });

  // Stage 8 share & replay
  E.btnShare.addEventListener("click", async ()=>{
    const url = window.location.href.split("#")[0];
    const text = "ğŸ’Œ Thiá»‡p 20/10 cá»±c xinh mÃ¬nh vá»«a nháº­n, cÃ¹ng khÃ¡m phÃ¡ nhÃ©!";
    try{
      if(navigator.share){
        await navigator.share({title:"Thiá»‡p 20/10 â€“ HÃ nh TrÃ¬nh Ná»Ÿ Hoa", text, url});
      }else{
        await navigator.clipboard.writeText(url);
        alert("ÄÃ£ sao chÃ©p liÃªn káº¿t chia sáº»!");
      }
    }catch{
      await navigator.clipboard.writeText(url);
      alert("ÄÃ£ sao chÃ©p liÃªn káº¿t chia sáº»!");
    }
  });
  E.btnReplay.addEventListener("click", ()=>{
    showStage(1);
    msgIndex=0; catched=0;
  });

  // play bgm on first body click (autoplay policy)
  document.body.addEventListener("click", ()=>{ if(E.bgm.paused){ try{E.bgm.play();}catch{}} }, { once:true });

  // init
  showStage(1);

  // ------------- Minimal sanity checks (in dev console) -------------
  try{
    console.assert(typeof showStage === "function", "Test: showStage exists");
    console.assert(ASSETS.gifts.length>=3, "Test: need at least 3 gift images");
    console.assert(ASSETS.messages.length>=3, "Test: need at least 3 messages");
  }catch(e){ console.warn("Sanity checks warning:", e); }
</script>
</body>
</html>
