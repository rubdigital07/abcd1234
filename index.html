<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1,user-scalable=no"/>
<title>Thiệp 20/10 – Hành Trình Nở Hoa 🌸</title>
<link href="https://fonts.googleapis.com/css2?family=Mali:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  :root{
    --rose:#d81b60;
    --rose-2:#f06292;
    --bg1:#fff0f5;
    --bg2:#ffeaf0;
  }
  body{
    font-family:"Mali",cursive;
    background:linear-gradient(135deg,var(--bg1),var(--bg2));
    height:100vh; overflow:hidden; color:var(--rose);
  }
  button{cursor:pointer; border:none; outline:none}
  .hidden{display:none !important;}
  .center{
    position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
    background:rgba(255,255,255,.86); border-radius:28px; padding:28px 32px;
    text-align:center; box-shadow:0 20px 60px rgba(216,27,96,.28);
    backdrop-filter:saturate(1.1) blur(6px); width:min(92vw,720px);
  }
  .title{
    font-weight:700; font-size:2rem;
    background:linear-gradient(45deg,var(--rose),var(--rose-2));
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    margin-bottom:8px;
  }
  .desc{font-size:1.1rem; line-height:1.65}
  .btn{
    margin-top:18px; padding:12px 22px; border-radius:28px; color:#fff;
    background:linear-gradient(135deg,var(--rose),var(--rose-2));
    font-weight:700; box-shadow:0 8px 24px rgba(216,27,96,.32);
    transition:.25s transform; display:inline-flex; align-items:center; gap:.5rem;
  }
  .btn:hover{transform:translateY(-1px) scale(1.02)}
  .btn-outline{
    background:#fff; color:var(--rose); border:2px solid var(--rose-2);
  }
  .fade-in{animation:fadeIn .6s ease forwards}
  @keyframes fadeIn{from{opacity:0; transform:translate(-50%,-48%)}to{opacity:1; transform:translate(-50%,-50%)}}

  /* Stage 2 falling */
  .falling{
    position:absolute; top:-80px; width:54px; user-select:none;
    animation:fall 9s linear forwards; filter:drop-shadow(0 6px 10px rgba(0,0,0,.18));
  }
  @keyframes fall{
    0%{transform:translateY(-10vh) rotate(0deg); opacity:1}
    100%{transform:translateY(110vh) rotate(360deg); opacity:.15}
  }
  /* Popup */
  .popup{
    position:fixed; top:50%; left:50%; transform:translate(-50%,-50%) scale(.85);
    background:#fff; border-radius:24px; padding:20px; width:min(90vw,420px);
    text-align:center; box-shadow:0 20px 70px rgba(216,27,96,.4); z-index:20;
    opacity:0; pointer-events:none; transition:.3s ease;
  }
  .popup.active{opacity:1; transform:translate(-50%,-50%) scale(1); pointer-events:auto}
  .popup img{width:100%; border-radius:18px; margin-bottom:12px}
  .popup p{line-height:1.6; font-weight:600}
  /* Hearts */
  .heart{
    position:absolute; pointer-events:none;
    animation:burst 1.5s ease-out forwards; font-size:20px;
  }
  @keyframes burst{
    0%{transform:translate(-50%,-50%) scale(.55); opacity:1}
    100%{transform:translate(var(--dx),var(--dy)) scale(1.9); opacity:0}
  }
  /* Fireworks */
  .fw{
    position:fixed; width:6px; height:6px; border-radius:50%; background:#ff80ab;
    animation:fw 1.2s ease-out forwards; pointer-events:none;
  }
  @keyframes fw{
    from{transform:translate(0,0) scale(1); opacity:1}
    to{transform:translate(var(--x),var(--y)) scale(0); opacity:0}
  }
  /* Gift box (stage 6) */
  .gift-wrap{
    display:flex; align-items:center; justify-content:center; gap:14px; margin-top:14px;
  }
  .gift{
    width:120px; height:120px; border-radius:16px; background:#ffe2ec;
    display:flex; align-items:center; justify-content:center;
    box-shadow:0 16px 40px rgba(216,27,96,.25); position:relative; overflow:hidden;
  }
  .ribbon{
    position:absolute; width:20px; height:100%; background:var(--rose); left:calc(50% - 10px);
  }
  .ribbon:before{
    content:""; position:absolute; top:calc(50% - 10px); left:-50px; right:-50px; height:20px; background:var(--rose);
  }
  .gift:hover{transform:translateY(-2px)}
  .box-lid{
    position:absolute; top:-4px; left:8px; right:8px; height:22px; border-radius:12px;
    background:linear-gradient(45deg,#ffc2d6,#ffa3c5);
  }
  .sparkle{position:absolute; width:6px; height:6px; border-radius:50%; background:#fff; opacity:.8; animation:sp 1.8s ease-out infinite}
  @keyframes sp{from{transform:translateY(0) scale(.6)}to{transform:translateY(-26px) scale(1.2); opacity:0}}
  /* Stage stepper */
  .stepper{position:fixed; top:12px; left:50%; transform:translateX(-50%); display:flex; gap:8px; z-index:9}
  .dot{width:10px; height:10px; border-radius:999px; background:#ffd1e2; opacity:.65}
  .dot.active{background:var(--rose); opacity:1}
  /* Input wish (stage 7) */
  .wish-box{margin-top:14px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap}
  .wish-box textarea{
    width:min(86vw,520px); height:90px; padding:10px 12px; border-radius:14px; border:2px solid #ffd1e2;
    outline:none; font-family:"Mali",cursive; color:var(--rose)
  }
  .sky{
    position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:0;
  }
  .float-text{
    position:absolute; left:50%; transform:translateX(-50%);
    color:var(--rose); font-weight:700; opacity:0; animation:floatUp 6s ease forwards;
    text-shadow:0 2px 0 #fff;
  }
  @keyframes floatUp{0%{bottom:-20px; opacity:0}20%{opacity:1}100%{bottom:84%; opacity:0}}
  /* Tooltip/hint */
  .hint{
    position:fixed; top:14px; left:50%; transform:translateX(-50%);
    background:#fff; padding:8px 16px; border-radius:20px; box-shadow:0 8px 24px rgba(216,27,96,.2);
    z-index:8; opacity:0; animation:hint 7s ease forwards; color:var(--rose); font-weight:600
  }
  @keyframes hint{
    0%{opacity:0; transform:translate(-50%,-6px)} 10%,75%{opacity:1; transform:translate(-50%,0)} 100%{opacity:0; transform:translate(-50%,-6px)}
  }
  /* Responsive */
  @media (max-width:768px){
    .title{font-size:1.5rem}
    .desc{font-size:1.02rem}
    .gift{width:104px; height:104px}
  }
</style>
</head>
<body>

<!-- Floating sky for stage 7 text -->
<div class="sky" id="sky"></div>

<!-- Stepper -->
<div class="stepper" id="stepper"></div>
<div class="hint">🌸 Hướng dẫn: Làm theo nút trên màn hình & chạm vào quà để khám phá!</div>

<!-- Stage 1 – Khởi đầu -->
<section id="stage1" class="center fade-in">
  <div class="title">Chúc mừng 20/10</div>
  <p class="desc">Một ngày mới bắt đầu – ngày dành riêng cho bạn. Cùng bước vào hành trình nở hoa nhé! 💌</p>
  <button class="btn" id="btnStart">Bắt đầu hành trình</button>
</section>

<!-- Stage 2 – Cơn mưa quà rơi -->
<section id="stage2" class="center hidden">
  <div class="title">Cơn mưa yêu thương 🌸</div>
  <p class="desc">Chạm vào những món quà rơi xuống để nhận lời chúc đầu tiên (bắt 3 món)!</p>
</section>

<!-- Popup lời chúc (Stage 3) -->
<div id="popup" class="popup">
  <img id="popupImg" alt="gift"/>
  <p id="popupText"></p>
  <button class="btn" id="btnPopupNext">Tiếp tục 🌺</button>
</div>

<!-- Stage 4 – Pháo hoa cảm ơn -->
<section id="stage4" class="center hidden">
  <div class="title">🌺 Cảm ơn bạn 🌺</div>
  <p class="desc">Vì đã mang đến thế giới này sự dịu dàng, mạnh mẽ và yêu thương. Hãy đón nhận điều bất ngờ tiếp theo!</p>
  <button class="btn" id="btnToBox">Mở hộp quà bí mật 🎁</button>
</section>

<!-- Stage 6 – Hộp quà bí mật -->
<section id="stage6" class="center hidden">
  <div class="title">Hộp quà bí mật 🎁</div>
  <p class="desc">Click vào một trong ba hộp quà để mở. Bên trong là điều xinh xắn dành cho bạn!</p>
  <div class="gift-wrap" id="giftWrap">
    <div class="gift" data-i="0"><div class="box-lid"></div><div class="ribbon"></div></div>
    <div class="gift" data-i="1"><div class="box-lid"></div><div class="ribbon"></div></div>
    <div class="gift" data-i="2"><div class="box-lid"></div><div class="ribbon"></div></div>
  </div>
  <button class="btn" id="btnToWrite">Viết lời chúc của bạn ✍️</button>
</section>

<!-- Stage 7 – Viết lời chúc -->
<section id="stage7" class="center hidden">
  <div class="title">Viết lời chúc</div>
  <p class="desc">Gửi một lời nhắn ngắn gọn đến chính bạn hoặc ai đó mà bạn trân trọng. Lời chúc sẽ bay lên bầu trời! ✨</p>
  <div class="wish-box">
    <textarea id="wishInput" placeholder="Ví dụ: Chúc bạn luôn bình an và rực rỡ như hôm nay!"></textarea>
    <button class="btn" id="btnWish">Thả lời chúc lên trời 💖</button>
  </div>
  <button class="btn btn-outline" id="btnToEnd">Kết thúc hành trình 🌷</button>
</section>

<!-- Stage 8 – Lời kết & chia sẻ -->
<section id="stage8" class="center hidden">
  <div class="title">💐 Chúc mừng 20/10 💐</div>
  <p class="desc" id="endDesc">Mỗi bông hoa đều đẹp theo cách riêng. Và bạn cũng thế. Hãy lan tỏa yêu thương nhé!</p>
  <div style="display:flex;gap:10px; justify-content:center; flex-wrap:wrap; margin-top:10px">
    <button class="btn" id="btnShare">📤 Chia sẻ thiệp</button>
    <button class="btn btn-outline" id="btnReplay">🔁 Chơi lại hành trình</button>
  </div>
</section>

<!-- Audio -->
<audio id="bgm" src="./assets/a.mp3" preload="auto"></audio>

<script>
  // ---------- Config ----------
  const ASSETS = {
    gifts: ["./assets/a1.jpg","./assets/a2.jpg","./assets/a3.jpg","./assets/a4.jpg"],
    messages: [
      "Chúc bạn luôn xinh đẹp và ngập tràn yêu thương 💐",
      "Hôm nay, mọi ánh sáng đều thuộc về bạn ✨",
      "Cảm ơn bạn vì đã mang điều tốt đẹp đến thế giới này 💖",
      "Bạn chính là đoá hoa đẹp nhất của ngày hôm nay 🌸"
    ]
  };

  // ---------- State ----------
  let stage = 1;
  let catched = 0;         // cần bắt 3 món ở stage 2
  let msgIndex = 0;

  // ---------- Elements ----------
  const el = (id)=>document.getElementById(id);
  const E = {
    stepper: el("stepper"),
    popup: el("popup"),
    popupImg: el("popupImg"),
    popupText: el("popupText"),
    btnPopupNext: el("btnPopupNext"),
    stage1: el("stage1"),
    stage2: el("stage2"),
    stage4: el("stage4"),
    stage6: el("stage6"),
    stage7: el("stage7"),
    stage8: el("stage8"),
    btnStart: el("btnStart"),
    btnToBox: el("btnToBox"),
    btnToWrite: el("btnToWrite"),
    btnWish: el("btnWish"),
    btnToEnd: el("btnToEnd"),
    btnShare: el("btnShare"),
    btnReplay: el("btnReplay"),
    bgm: el("bgm"),
    wishInput: el("wishInput"),
    giftWrap: el("giftWrap"),
    sky: el("sky"),
    endDesc: el("endDesc")
  };

  // ---------- Helpers ----------
  function showStage(n){
    stage = n;
    [1,2,4,6,7,8].forEach(s=>{
      const node = el("stage"+s);
      if(!node) return;
      if(s===n) node.classList.remove("hidden"); else node.classList.add("hidden");
    });
    // popup off when switching
    E.popup.classList.remove("active");
    renderStepper(n);
  }

  function renderStepper(n){
    const total = 8;
    E.stepper.innerHTML = "";
    for (let i=1;i<=total;i++){
      const d = document.createElement("div");
      d.className = "dot"+(i<=n?" active":"");
      E.stepper.appendChild(d);
    }
  }

  function heartBurst(x,y,count=10){
    for(let i=0;i<count;i++){
      const h = document.createElement("div");
      h.className = "heart"; h.textContent = "💖";
      const a = Math.random()*Math.PI*2;
      const d = 60 + Math.random()*80;
      h.style.left = x+"px";
      h.style.top = y+"px";
      h.style.setProperty("--dx", Math.cos(a)*d + "px");
      h.style.setProperty("--dy", Math.sin(a)*d + "px");
      document.body.appendChild(h);
      setTimeout(()=>h.remove(),1500);
    }
  }

  function fireworks(times=46){
    for(let i=0;i<times;i++){
      const f = document.createElement("div");
      f.className="fw";
      const cx = window.innerWidth/2, cy=window.innerHeight/2;
      f.style.left = cx+"px"; f.style.top = cy+"px";
      const a = Math.random()*Math.PI*2;
      const dist = 110 + Math.random()*220;
      f.style.setProperty("--x", Math.cos(a)*dist+"px");
      f.style.setProperty("--y", Math.sin(a)*dist+"px");
      document.body.appendChild(f);
      setTimeout(()=>f.remove(),1200);
    }
  }

  // random falling item
  function spawnFalling(){
    if(stage!==2) return;
    const img = document.createElement("img");
    img.src = ASSETS.gifts[Math.floor(Math.random()*ASSETS.gifts.length)];
    img.className = "falling";
    img.style.left = (Math.random()*(window.innerWidth-70))+"px";
    img.addEventListener("click", e=>{
      img.remove();
      catched++;
      heartBurst(e.clientX, e.clientY, 12);
      showPopup();
      if(catched>=3){
        // sẽ chuyển stage ở nút popup
      }
    });
    document.body.appendChild(img);
    setTimeout(()=>img.remove(),9000);
  }

  let dropTimer=null;
  function startRain(){
    catched = 0;
    spawnFalling();
    dropTimer = setInterval(spawnFalling, 1200);
  }
  function stopRain(){
    if(dropTimer) clearInterval(dropTimer);
    dropTimer = null;
  }

  function showPopup(){
    E.popupImg.src = ASSETS.gifts[msgIndex % ASSETS.gifts.length];
    E.popupText.innerHTML = ASSETS.messages[msgIndex % ASSETS.messages.length];
    msgIndex++;
    E.popup.classList.add("active");
  }

  function saveWishToSky(text){
    if(!text.trim()) return;
    localStorage.setItem("my_2010_wish", text.trim());
    const t = document.createElement("div");
    t.className="float-text";
    t.style.fontSize = (16 + Math.random()*8) + "px";
    t.style.left = (30 + Math.random()*40) + "%";
    t.textContent = "“ " + text.t
