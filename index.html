<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Comfort Journey v5 ‚Äì Phong th∆∞ 3 l·ªùi ch√∫c + b√≥ hoa</title>
<style>
:root{--bg1:#fff7fb;--bg2:#f0fbff;--card:#ffffff;--text:#1f2937;--muted:#64748b;--accent:#fb7185;--ok:#34d399;--shadow:0 10px 30px rgba(2,8,23,.08)}
.dark{--bg1:#0b1020;--bg2:#0e1224;--card:#111827;--text:#e5e7eb;--muted:#94a3b8;--accent:#fb7185;--ok:#22d3ee;--shadow:0 10px 30px rgba(0,0,0,.35)}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:linear-gradient(135deg,var(--bg1),#fff 45%,var(--bg2));color:var(--text);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.container{max-width:960px;margin:0 auto;padding:24px}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:space-between;align-items:center;margin-bottom:16px}
.btn{appearance:none;border:0;border-radius:14px;padding:10px 14px;background:#0ea5e9;color:#fff;font-weight:700;cursor:pointer;box-shadow:var(--shadow);transition:.2s}
.btn:hover{filter:brightness(1.05)} .btn.ghost{background:transparent;color:var(--text);border:1px solid #e2e8f0}
.btn.secondary{background:linear-gradient(90deg,var(--accent),#f472b6)} .btn.ok{background:linear-gradient(90deg,var(--ok),#10b981)}
.card{background:var(--card);border-radius:18px;box-shadow:var(--shadow);overflow:hidden}
header.h{padding:16px;border-bottom:1px solid rgba(148,163,184,.18);font-weight:800}
.content{padding:18px}
.center{display:grid;place-items:center;text-align:center}
.stage{display:none} .stage.active{display:block;animation:fade .45s ease}
@keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* Stage 2 ‚Äì Letter */
.letter{width:260px;height:180px;margin:20px auto;background:#fff;border-radius:12px;border:1px solid #e5e7eb;box-shadow:0 10px 20px rgba(2,8,23,.08);position:relative;cursor:pointer;overflow:hidden}
.flap{position:absolute;inset:0;background:linear-gradient(#f8fafc,#e2e8f0);clip-path:polygon(0 0,100% 0,50% 60%);transition:.6s;z-index:3}
.letter.open .flap{transform:translateY(-95%);opacity:0}
.seal{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:60px;height:60px;border-radius:999px;background:radial-gradient(circle at 30% 30%, #fecaca, #f43f5e);display:grid;place-items:center;color:#fff;font-weight:800;box-shadow:0 6px 18px rgba(244,63,94,.4);z-index:4;transition:.4s}
.letter.open .seal{opacity:0;transform:translate(-50%,-60%) scale(.9)}
.msgbox{position:absolute;left:0;right:0;bottom:12px;padding:0 16px;text-align:center;opacity:0;transition:.6s;z-index:2}
.letter.open .msgbox{opacity:1;bottom:20px}
.msgbox p{margin:6px 0;font-size:15px;opacity:0;transform:translateY(4px);animation:lineIn .6s forwards ease}
.msgbox p:nth-child(1){animation-delay:.35s} .msgbox p:nth-child(2){animation-delay:.7s} .msgbox p:nth-child(3){animation-delay:1.05s}
@keyframes lineIn{to{opacity:1;transform:translateY(0)}}

/* Stage 3 ‚Äì Garden */
.garden{position:relative;height:320px;border-radius:14px;background:linear-gradient(#ecfeff,#fff 40%,#f0fdf4);cursor:pointer;overflow:hidden}
.garden .meadow{position:absolute;left:0;right:0;bottom:0;height:90px;background:linear-gradient(to top, rgba(34,197,94,.35),transparent)}
.flower{position:absolute;transform:translate(-50%,-50%)}
.bud{display:grid;place-items:center;border:1px solid rgba(255,255,255,.6);border-radius:999px;box-shadow:0 8px 16px rgba(2,8,23,.12);animation:sway 6s ease-in-out infinite}
@keyframes sway{0%{transform:rotate(0)}25%{transform:rotate(4deg)}50%{transform:rotate(0)}75%{transform:rotate(-4deg)}100%{transform:rotate(0)}}
.note{margin-top:8px;background:rgba(255,255,255,.85);backdrop-filter:blur(6px);padding:4px 8px;border-radius:10px;font-size:12px;color:#334155;display:inline-block}
.dark .note{background:rgba(15,23,42,.7);color:#e2e8f0;border:1px solid rgba(255,255,255,.06)}

/* Stage 4 ‚Äì Gift + Bouquet */
.gift{width:220px;height:160px;margin:12px auto;border-radius:14px;background:linear-gradient(135deg,#fde68a,#fca5a5);position:relative;box-shadow:var(--shadow);cursor:pointer}
.lid{position:absolute;left:0;right:0;top:0;height:40%;background:linear-gradient(135deg,#f472b6,#fb7185);border-top-left-radius:14px;border-top-right-radius:14px;transform-origin:top;transition:.5s}
.gift.open .lid{transform:rotateX(65deg)}
.bouquet{width:280px;height:240px;margin:14px auto 0;position:relative;opacity:0;transform:translateY(12px) scale(.98);transition:.5s ease}
.bouquet.show{opacity:1;transform:translateY(0) scale(1)}
.stem{position:absolute;bottom:0;width:4px;height:120px;background:linear-gradient(#10b981,#059669);transform-origin:bottom center;border-radius:6px;animation:stem-sway 5s ease-in-out infinite}
@keyframes stem-sway{0%{transform:rotate(0)}50%{transform:rotate(2deg)}100%{transform:rotate(0)}}
.head{position:absolute;bottom:110px;left:-18px;width:48px;height:48px;border-radius:999px;border:1px solid rgba(255,255,255,.6);box-shadow:0 6px 14px rgba(2,8,23,.12);display:grid;place-items:center;font-size:20px;transform:scale(0);animation:bloom .6s ease forwards}
@keyframes bloom{from{transform:scale(.2);opacity:.2}to{transform:scale(1);opacity:1}}
.wrap{position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:200px;height:110px;border-bottom-left-radius:28px;border-bottom-right-radius:28px;background:linear-gradient(180deg,#fef3c7,#fecaca)}

/* Hearts + petals */
.heart{position:absolute;left:50%;top:0;transform:translateX(-50%);opacity:0}
@keyframes pop{0%{opacity:0;transform:translate(-50%,0) scale(.5)}30%{opacity:1}100%{opacity:0;transform:translate(calc(-50% + var(--x)), var(--y)) scale(var(--s))}}
.petal{position:fixed;top:-20px;width:10px;height:16px;background:linear-gradient(180deg,#fbcfe8,#f472b6);border-radius:10px 10px 2px 2px;opacity:.9;filter:drop-shadow(0 4px 6px rgba(0,0,0,.1));animation:fall linear forwards}
@keyframes fall{0%{transform:translate(var(--sx),-20px)}100%{transform:translate(var(--ex),110vh) rotate(360deg)}}

.fade-small{opacity:.8;font-size:14px;color:var(--muted)}
</style>
</head>
<body>
<div class="container">
  <div class="toolbar">
    <strong>üéÅ Comfort Journey v5</strong>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn ghost" id="modeBtn">Ch·∫ø ƒë·ªô t·ªëi</button>
      <button class="btn ghost" id="musicBtn">üéµ B·∫≠t nh·∫°c</button>
      <audio id="bgm" preload="none" loop src="https://cdn.pixabay.com/audio/2022/03/15/audio_1b96f2ce45.mp3"></audio>
    </div>
  </div>

  <section class="card">
    <header class="h">H√†nh tr√¨nh an ·ªßi ‚Äì phong th∆∞ 3 l·ªùi ch√∫c & b√≥ hoa</header>
    <div class="content">

      <!-- Stage 1 -->
      <div id="stage1" class="stage active center">
        <div>
          <h2>H√¥m nay b·∫°n c·∫£m th·∫•y th·∫ø n√†o?</h2>
          <div class="choices">
            <button class="btn secondary" data-feel="sad">Kh√¥ng ·ªïn üòî</button>
            <button class="btn" data-feel="ok">B√¨nh th∆∞·ªùng üôÇ</button>
            <button class="btn ok" data-feel="good">·ªîn h∆°n r·ªìi üå§Ô∏è</button>
          </div>
          <p class="fade-small" style="margin-top:10px">Ch·ªçn m·ªôt c·∫£m x√∫c ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
        </div>
      </div>

      <!-- Stage 2 -->
      <div id="stage2" class="stage center">
        <div>
          <h2>M·ªü phong th∆∞ n√® ‚úâÔ∏è</h2>
          <div id="letter" class="letter" title="Nh·∫•p ƒë·ªÉ m·ªü th∆∞">
            <div class="flap"></div>
            <div class="seal">‚ô•</div>
            <div class="msgbox" id="letterMsg"></div>
          </div>
          <button class="btn" id="toStage3" style="display:none;margin-top:8px">ƒê·ªçc ti·∫øp ‚Üí</button>
        </div>
      </div>

      <!-- Stage 3 -->
      <div id="stage3" class="stage">
        <h2 class="center">Tr·ªìng h·∫°t hy v·ªçng üå±</h2>
        <p class="center fade-small">Ch·∫°m v√†o khu v∆∞·ªùn ƒë·ªÉ tr·ªìng hoa (tr·ªìng 3 b√¥ng ƒë·ªÉ ti·∫øp t·ª•c).</p>
        <div class="garden" id="garden"><div class="meadow"></div></div>
        <div class="center" style="margin-top:10px">
          <button class="btn" id="toStage4" style="display:none">Xem ƒëi·ªÅu k·ª≥ di·ªáu ‚ú®</button>
        </div>
      </div>

      <!-- Stage 4 -->
      <div id="stage4" class="stage center">
        <div>
          <h2>H·ªôp qu√† b·∫•t ng·ªù üéÅ</h2>
          <div class="gift" id="gift"><div class="lid"></div></div>
          <div id="bouquet" class="bouquet" aria-hidden="true"></div>
          <p id="giftMsg" style="display:none;margin-top:8px"></p>
          <div style="margin-top:8px"><button class="btn" id="hugBtn" style="display:none">ü§ó Nh·∫≠n m·ªôt c√°i √¥m ·∫£o</button></div>
          <div style="margin-top:12px"><button class="btn ghost" id="toStage5" style="display:none">Ti·∫øp t·ª•c ‚Üí</button></div>
        </div>
      </div>

      <!-- Stage 5 -->
      <div id="stage5" class="stage center">
        <div>
          <h2>üíñ B·∫°n x·ª©ng ƒë√°ng ƒë∆∞·ª£c y√™u th∆∞∆°ng v√† b√¨nh y√™n</h2>
          <p id="finalLine" class="fade-small">D√π h√¥m nay ra sao, mai m√¨nh c√πng t·ªët h∆°n m·ªôt ch√∫t nh√©.</p>
          <div style="margin-top:10px"><button class="btn ok" id="restart">B·∫Øt ƒë·∫ßu l·∫°i h√†nh tr√¨nh</button></div>
        </div>
      </div>

    </div>
  </section>
</div>

<script>
/* ===== Messages & uniqueness ===== */
const AFF=["B·∫°n r·∫•t quan tr·ªçng ‚Äì h∆°n b·∫°n nghƒ© ƒë·∫•y.","H√¥m nay kh√≥, nh∆∞ng b·∫°n m·∫°nh m·∫Ω h∆°n kh√≥ khƒÉn.","M·ªôt b∆∞·ªõc nh·ªè h√¥m nay c≈©ng l√† ti·∫øn b·ªô l·ªõn.","B·∫°n kh√¥ng c√¥ ƒë∆°n ‚Äì m√¨nh lu√¥n ·ªü ƒë√¢y.","Tr√°i tim b·∫°n x·ª©ng ƒë√°ng ƒë∆∞·ª£c d·ªãu d√†ng.","S√≥ng gi√≥ n√†o r·ªìi c≈©ng qua, b·∫ßu tr·ªùi s·∫Ω trong l·∫°i.","C∆∞·ªùi nh·∫π m·ªôt c√°i nh√© ‚Äì d·ªÖ th∆∞∆°ng l·∫Øm!","B·∫°n c√≥ quy·ªÅn ngh·ªâ ng∆°i ‚Äì v√† b·∫°n x·ª©ng ƒë√°ng v·ªõi ƒëi·ªÅu ƒë√≥.","Ng√†y mai s·∫Ω t·ªët h∆°n h√¥m nay m·ªôt ch√∫t, m√¨nh c√πng ch·ªù nh√©."];
const NICE=["B·∫°n l√†m t·ªët h∆°n b·∫°n t∆∞·ªüng nhi·ªÅu l·∫Øm.","C·∫£m ∆°n b·∫°n v√¨ ƒë√£ c·ªë g·∫Øng ƒë·∫øn t·∫≠n b√¢y gi·ªù.","Th·∫£ l·ªèng vai, nh·∫Øm m·∫Øt 2 gi√¢y ‚Äì d·ªÖ ch·ªãu h∆°n ch∆∞a?","M·ªôt c·ªëc n∆∞·ªõc ·∫•m s·∫Ω gi√∫p b·∫°n n√®.","M·ªâm c∆∞·ªùi m·ªôt ch√∫t, tim s·∫Ω ·∫•m h∆°n.","H√£y nh·∫π nh√†ng v·ªõi ch√≠nh m√¨nh nh√©."];
let used=new Set(), pool=AFF, planted=0;
const allPool=()=>[...AFF,...NICE];
const sample=a=>a[Math.floor(Math.random()*a.length)];
const rand=(min,max)=>Math.random()*(max-min)+min;
function nextUnique(preferredFirst=[]){
  const cand1=preferredFirst.filter(x=>!used.has(x));
  if(cand1.length){const m=sample(cand1);used.add(m);return m}
  const cand2=allPool().filter(x=>!used.has(x));
  if(cand2.length){const m=sample(cand2);used.add(m);return m}
  used.clear(); // h·∫øt c√¢u th√¨ reset chu k·ª≥ m·ªõi
  return nextUnique(preferredFirst.length?preferredFirst:allPool());
}

/* ===== DOM helpers ===== */
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s), stage=i=>$("#stage"+i);
function go(n){for(let i=1;i<=5;i++){stage(i).classList.toggle("active", i===n)}}

/* ===== Mode & Music ===== */
const modeBtn=$("#modeBtn"), musicBtn=$("#musicBtn"), bgm=$("#bgm");
modeBtn.onclick=()=>{document.documentElement.classList.toggle("dark");modeBtn.textContent=document.documentElement.classList.contains("dark")?"Ch·∫ø ƒë·ªô s√°ng":"Ch·∫ø ƒë·ªô t·ªëi";}
musicBtn.onclick=()=>{try{ if(bgm.paused){bgm.play();musicBtn.textContent="üéµ T·∫Øt nh·∫°c"}else{bgm.pause();musicBtn.textContent="üéµ B·∫≠t nh·∫°c"} }catch{}}

/* ===== Stage 1 ‚Üí 2 ===== */
$$('#stage1 .btn').forEach(b=>b.onclick=()=>{ pool=b.dataset.feel==="sad"?AFF:NICE; go(2); });

/* ===== Stage 2 ‚Äì Letter with 3 lines ===== */
const letter=$("#letter"), letterMsg=$("#letterMsg"), to3=$("#toStage3");
letter.onclick=()=>{
  letter.classList.add("open");
  // t·∫°o 3 c√¢u kh√¥ng tr√πng nhau
  const three=[nextUnique(pool), nextUnique(pool), nextUnique(pool)];
  letterMsg.innerHTML="";
  three.forEach(t=>{const p=document.createElement("p"); p.textContent=t; letterMsg.appendChild(p);});
  setTimeout(()=>{to3.style.display="inline-block"},1200);
};
to3.onclick=()=>go(3);

/* ===== Stage 3 ‚Äì Garden ===== */
const garden=$("#garden"), to4=$("#toStage4");
function plant(x,y){
  const size=rand(48,86);
  const el=document.createElement("div"); el.className="flower"; el.style.left=x+"%"; el.style.top=y+"%";
  const bud=document.createElement("div"); bud.className="bud"; bud.style.width=size+"px"; bud.style.height=size+"px";
  const c1=sample(['#fbcfe8','#fecaca','#fde68a','#bae6fd','#ddd6fe','#bbf7d0']), c2=sample(['#f472b6','#fb7185','#f59e0b','#60a5fa','#a78bfa','#34d399']);
  bud.style.background=`linear-gradient(135deg,${c1},${c2})`; bud.textContent="üåº"; bud.style.fontSize="22px";
  const note=document.createElement("span"); note.className="note"; note.textContent=nextUnique(pool);
  el.appendChild(bud); el.appendChild(note); garden.appendChild(el);
}
garden.onclick=e=>{
  const r=garden.getBoundingClientRect();
  const x=((e.clientX-r.left)/r.width)*100, y=((e.clientY-r.top)/r.height)*100;
  plant(x,y); planted++; if(planted>=3) to4.style.display="inline-block";
};
to4.onclick=()=>{ go(4); try{ if(bgm.paused) bgm.play(); musicBtn.textContent="üéµ T·∫Øt nh·∫°c"; }catch{} };

/* ===== Stage 4 ‚Äì Gift ‚Üí Bouquet ===== */
const gift=$("#gift"), bouquet=$("#bouquet"), giftMsg=$("#giftMsg"), hug=$("#hugBtn"), to5=$("#toStage5");
function createBouquet(){
  bouquet.innerHTML="";
  const wrap=document.createElement("div"); wrap.className="wrap"; bouquet.appendChild(wrap);
  const heads=[['#fbcfe8','#f472b6','üå∏'],['#fecaca','#fb7185','üå∫'],['#fde68a','#f59e0b','üåº'],['#bae6fd','#60a5fa','üå∑'],['#ddd6fe','#a78bfa','üíÆ']];
  const cx=140;
  heads.forEach((p,i)=>{const [c1,c2,emo]=p; const stem=document.createElement("div"); stem.className="stem"; const offset=(i-2)*24; stem.style.left=(cx+offset)+"px"; stem.style.height=(110+Math.abs(i-2)*8)+"px";
    const head=document.createElement("div"); head.className="head"; head.style.background=`linear-gradient(135deg,${c1},${c2})`; head.textContent=emo; head.style.animationDelay=(0.12*i)+"s";
    stem.appendChild(head); bouquet.appendChild(stem);
  });
  bouquet.classList.add("show");
}
gift.onclick=()=>{
  gift.classList.add("open");
  setTimeout(()=>{ createBouquet(); giftMsg.style.display="block"; giftMsg.textContent="üíê M·ªôt b√≥ hoa d√†nh ri√™ng cho b·∫°n ‚Äì v√¨ b·∫°n x·ª©ng ƒë√°ng ƒë∆∞·ª£c y√™u th∆∞∆°ng nh∆∞ th·∫ø n√†y."; hug.style.display="inline-block"; to5.style.display="inline-block"; }, 450);
};
hug.onclick=()=>{
  for(let i=0;i<18;i++){
    const h=document.createElement("div"); h.className="heart";
    h.style.animation="pop 1.1s ease-out forwards";
    h.style.setProperty('--x',`${rand(-140,140)}px`);
    h.style.setProperty('--y',`${rand(-180,-60)}px`);
    h.style.setProperty('--s',rand(.9,1.4));
    h.innerHTML='<svg width="22" height="22" viewBox="0 0 24 24" fill="#fb7185" xmlns="http://www.w3.org/2000/svg"><path d="M12 21s-6.716-4.778-9.428-7.49A5.6 5.6 0 0 1 11.1 5.98L12 7l.9-1.02a5.6 5.6 0 0 1 8.528 7.53C18.716 16.222 12 21 12 21z"/></svg>';
    gift.parentElement.appendChild(h); setTimeout(()=>h.remove(),1100);
  }
};
to5.onclick=()=>{
  $("#finalLine").textContent=nextUnique(allPool()); // c√¢u k·∫øt c≈©ng kh√¥ng tr√πng
  go(5);
  for(let i=0;i<18;i++){const p=document.createElement("div"); p.className="petal"; p.style.left=Math.random()*100+"vw"; p.style.setProperty('--sx',rand(-50,50)+'px'); p.style.setProperty('--ex',rand(-120,120)+'px'); p.style.animationDuration=(6+Math.random()*4)+'s'; document.body.appendChild(p); setTimeout(()=>p.remove(),11000);}
};

/* ===== Restart ===== */
$("#restart").onclick=()=>{
  used.clear(); planted=0; pool=AFF;
  // Reset UI
  $("#letter").classList.remove("open"); $("#letterMsg").innerHTML=""; $("#toStage3").style.display="none";
  $("#garden").innerHTML='<div class="meadow"></div>'; $("#toStage4").style.display="none";
  $("#gift").classList.remove("open"); $("#bouquet").classList.remove("show"); $("#bouquet").innerHTML="";
  $("#giftMsg").style.display="none"; $("#hugBtn").style.display="none"; $("#toStage5").style.display="none";
  go(1);
  try{ bgm.pause(); musicBtn.textContent="üéµ B·∫≠t nh·∫°c"; }catch{}
};
</script>
</body>
</html>
