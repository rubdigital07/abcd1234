<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1,user-scalable=no" />
  <title>Thiá»‡p 20/10 â€“ HÃ nh TrÃ¬nh Ná»Ÿ Hoa ğŸ’</title>
  <link href="https://fonts.googleapis.com/css2?family=Mali:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--rose:#d81b60;--rose2:#f06292;--bg1:#fff0f5;--bg2:#ffeaf0}
    body{font-family:"Mali",cursive;background:linear-gradient(135deg,var(--bg1),var(--bg2));height:100vh;overflow:hidden;color:var(--rose)}
    button{cursor:pointer;border:none;outline:none}
    .hidden{display:none!important}

    .center{
      position:absolute;top:50%;left:50%;
      transform:translate(-50%,-50%) scale(.96);
      opacity:0;background:rgba(255,255,255,.88);
      border-radius:28px;padding:28px 32px;text-align:center;
      width:min(92vw,720px);
      box-shadow:0 20px 60px rgba(216,27,96,.28);
      backdrop-filter:saturate(1.1) blur(6px);
      transition:opacity .4s ease, transform .4s ease;
    }
    .center.show{opacity:1;transform:translate(-50%,-50%) scale(1)}

    .title{
      font-weight:700;font-size:2rem;
      background:linear-gradient(45deg,var(--rose),var(--rose2));
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
      margin-bottom:8px
    }
    .desc{font-size:1.1rem;line-height:1.65}
    .btn{
      margin-top:18px;padding:12px 22px;border-radius:28px;color:#fff;
      background:linear-gradient(135deg,var(--rose),var(--rose2));
      font-weight:700;box-shadow:0 8px 24px rgba(216,27,96,.32);
      transition:.2s transform;display:inline-flex;align-items:center;gap:.5rem
    }
    .btn:hover{transform:translateY(-1px) scale(1.02)}
    .btn-outline{background:#fff;color:var(--rose);border:2px solid var(--rose2)}

    /* Tim ná»• */
    .heart{position:absolute;pointer-events:none;animation:burst 1.5s ease-out forwards;font-size:20px}
    @keyframes burst{
      0%{transform:translate(-50%,-50%) scale(.55);opacity:1}
      100%{transform:translate(var(--dx),var(--dy)) scale(1.9);opacity:0}
    }

    /* QuÃ  rÆ¡i */
    .falling{
      position:absolute;top:-80px;width:54px;user-select:none;
      animation:fall 9s linear forwards;
      filter:drop-shadow(0 6px 10px rgba(0,0,0,.18))
    }
    @keyframes fall{
      0%{transform:translateY(-10vh) rotate(0deg);opacity:1}
      100%{transform:translateY(110vh) rotate(360deg);opacity:.15}
    }

    /* Há»™p quÃ  */
    .gift-wrap{display:flex;align-items:center;justify-content:center;gap:14px;margin-top:14px}
    .gift{
      width:120px;height:120px;border-radius:16px;background:#ffe2ec;
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 16px 40px rgba(216,27,96,.25);
      position:relative;overflow:hidden
    }
    .ribbon{position:absolute;width:20px;height:100%;background:var(--rose);left:calc(50% - 10px)}
    .ribbon:before{content:"";position:absolute;top:calc(50% - 10px);left:-50px;right:-50px;height:20px;background:var(--rose)}
    .box-lid{
      position:absolute;top:-4px;left:8px;right:8px;height:22px;border-radius:12px;
      background:linear-gradient(45deg,#ffc2d6,#ffa3c5)
    }

    /* BÃ³ hoa + Ã¡nh sÃ¡ng */
    .flower-rise{
      position:fixed;left:50%;top:65%;
      transform:translateX(-50%) scale(.8);
      width:220px;opacity:0;z-index:100;
      animation:flowerRise 3s ease-out forwards;pointer-events:none
    }
    @keyframes flowerRise{
      0%{opacity:0;transform:translate(-50%,30%) scale(.8)}
      20%{opacity:1;transform:translate(-50%,0) scale(1)}
      60%{opacity:1;transform:translate(-50%,-15%) scale(1.05)}
      100%{opacity:0;transform:translate(-50%,-60%) scale(1.2)}
    }
    .glow{
      position:fixed;left:50%;top:50%;width:420px;height:420px;
      transform:translate(-50%,-50%);
      background:radial-gradient(circle,rgba(255,182,193,.5)0%,rgba(255,192,203,.1)70%,transparent 100%);
      border-radius:50%;opacity:0;z-index:50;pointer-events:none;
      animation:glowEffect 3s ease-out forwards
    }
    @keyframes glowEffect{
      0%{opacity:0;transform:translate(-50%,-50%) scale(.4)}
      40%{opacity:.6;transform:translate(-50%,-50%) scale(1.1)}
      100%{opacity:0;transform:translate(-50%,-50%) scale(1.6)}
    }

    /* Thiá»‡p yÃªu thÆ°Æ¡ng */
    .envelope{position:relative;width:240px;height:180px;margin:0 auto 20px;perspective:1000px}
    .envelope-top{
      position:absolute;width:100%;height:100%;background:#ffc2d6;border-radius:8px;
      transform-origin:top;transition:transform .8s ease
    }
    .envelope.open .envelope-top{transform:rotateX(150deg)}
    .envelope-letter{
      position:absolute;inset:0;background:#fff;border-radius:8px;padding:20px;
      box-shadow:0 6px 20px rgba(0,0,0,.2);transform:translateY(100%);opacity:0;
      transition:all .8s ease .4s
    }
    .envelope.open .envelope-letter{transform:translateY(0);opacity:1}
    .letter-text{font-size:1.05rem;color:var(--rose)}
    .letter-deco{margin-top:12px;font-size:1.3rem}

    @media (max-width:768px){
      .title{font-size:1.6rem}
      .desc{font-size:1.02rem}
      .gift{width:104px;height:104px}
      .flower-rise{width:200px}
    }
  </style>
</head>
<body>
  <!-- Stage 1 -->
  <section id="stage1" class="center show">
    <div class="title">ChÃºc má»«ng 20/10</div>
    <p class="desc">Má»™t ngÃ y Ä‘áº·c biá»‡t dÃ nh riÃªng cho báº¡n â€“ cÃ¹ng báº¯t Ä‘áº§u hÃ nh trÃ¬nh ná»Ÿ hoa nhÃ© ğŸ’Œ</p>
    <button id="btnStart" class="btn">Báº¯t Ä‘áº§u hÃ nh trÃ¬nh</button>
  </section>

  <!-- Stage 2 -->
  <section id="stage2" class="center hidden">
    <div class="title">CÆ¡n mÆ°a yÃªu thÆ°Æ¡ng ğŸŒ¸</div>
    <p class="desc">Cháº¡m vÃ o 3 mÃ³n quÃ  rÆ¡i xuá»‘ng Ä‘á»ƒ nháº­n nhá»¯ng lá»i chÃºc Ä‘áº§u tiÃªn!</p>
  </section>

  <!-- Popup (Stage 3 overlay) -->
  <div id="popup" class="center hidden" style="max-width:540px">
    <div class="title">Lá»i chÃºc gá»­i Ä‘áº¿n báº¡n ğŸ’–</div>
    <img id="popupImg" src="" alt="Gift" style="width:100%;border-radius:16px;margin:12px 0;">
    <p id="popupText" class="desc"></p>
    <button id="btnPopupNext" class="btn">Tiáº¿p tá»¥c ğŸŒº</button>
  </div>

  <!-- Stage 4 -->
  <section id="stage4" class="center hidden">
    <div class="title">ğŸŒº Cáº£m Æ¡n báº¡n ğŸŒº</div>
    <p class="desc">VÃ¬ báº¡n Ä‘Ã£ mang Ä‘áº¿n tháº¿ giá»›i nÃ y sá»± dá»‹u dÃ ng, máº¡nh máº½ vÃ  yÃªu thÆ°Æ¡ng.</p>
    <button id="btnToBox" class="btn">Má»Ÿ há»™p quÃ  bÃ­ máº­t ğŸ</button>
  </section>

  <!-- Stage 5 (nháº£y nhanh sau 4: giá»¯ 8 stage logic náº¿u cáº§n má»Ÿ rá»™ng sau) -->
  <section id="stage5" class="center hidden">
    <div class="title">Khoáº£nh kháº¯c toáº£ sÃ¡ng âœ¨</div>
    <p class="desc">Sáºµn sÃ ng cho Ä‘iá»u báº¥t ngá» tiáº¿p theo nhÃ©!</p>
    <button id="btnToStage6" class="btn">Tiáº¿p tá»¥c</button>
  </section>

  <!-- Stage 6 â€“ Há»™p quÃ  -->
  <section id="stage6" class="center hidden">
    <div class="title">Há»™p quÃ  bÃ­ máº­t ğŸ</div>
    <p class="desc">Cháº¡m vÃ o má»™t há»™p Ä‘á»ƒ xem Ä‘iá»u báº¥t ngá» dÃ nh cho báº¡n!</p>
    <div id="giftWrap" class="gift-wrap">
      <div class="gift"><div class="box-lid"></div><div class="ribbon"></div></div>
      <div class="gift"><div class="box-lid"></div><div class="ribbon"></div></div>
      <div class="gift"><div class="box-lid"></div><div class="ribbon"></div></div>
    </div>
    <button id="btnToLetter" class="btn hidden">Má»Ÿ thiá»‡p yÃªu thÆ°Æ¡ng ğŸ’Œ</button>
  </section>

  <!-- Stage 7 â€“ Thiá»‡p yÃªu thÆ°Æ¡ng -->
  <section id="stage7" class="center hidden">
    <div class="title">ğŸ’Œ Má»Ÿ thiá»‡p yÃªu thÆ°Æ¡ng</div>
    <div class="envelope" id="envelope">
      <div class="envelope-top"></div>
      <div class="envelope-letter">
        <p class="letter-text">ChÃºc báº¡n luÃ´n xinh Ä‘áº¹p, háº¡nh phÃºc vÃ  Ä‘Æ°á»£c yÃªu thÆ°Æ¡ng trá»n váº¹n má»—i ngÃ y ğŸŒ·</p>
        <div class="letter-deco">ğŸ’–ğŸŒ¸ğŸ’–</div>
      </div>
    </div>
    <button id="btnToEnd" class="btn btn-outline">Káº¿t thÃºc hÃ nh trÃ¬nh ğŸŒ·</button>
  </section>

  <!-- Stage 8 -->
  <section id="stage8" class="center hidden">
    <div class="title">ğŸ’ ChÃºc má»«ng 20/10 ğŸ’</div>
    <p class="desc">Má»—i bÃ´ng hoa Ä‘á»u Ä‘áº¹p theo cÃ¡ch riÃªng â€“ vÃ  báº¡n cÅ©ng tháº¿. HÃ£y lan tá»a yÃªu thÆ°Æ¡ng nhÃ©!</p>
    <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:10px">
      <button id="btnShare" class="btn">ğŸ“¤ Chia sáº» thiá»‡p</button>
      <button id="btnReplay" class="btn btn-outline">ğŸ” ChÆ¡i láº¡i hÃ nh trÃ¬nh</button>
    </div>
  </section>

  <audio id="bgm" src="./assets/a.mp3" preload="auto"></audio>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // --- Utils & State ---
      const $ = (id) => document.getElementById(id);
      const gifts = ["./assets/a1.jpg","./assets/a2.jpg","./assets/a3.jpg","./assets/a4.jpg"];
      const messages = [
        "ChÃºc báº¡n luÃ´n xinh Ä‘áº¹p vÃ  ngáº­p trÃ n yÃªu thÆ°Æ¡ng ğŸ’",
        "HÃ´m nay, má»i Ã¡nh sÃ¡ng Ä‘á»u thuá»™c vá» báº¡n âœ¨",
        "Cáº£m Æ¡n báº¡n vÃ¬ Ä‘Ã£ mang Ä‘iá»u tá»‘t Ä‘áº¹p Ä‘áº¿n tháº¿ giá»›i nÃ y ğŸ’–",
        "Báº¡n chÃ­nh lÃ  Ä‘oÃ¡ hoa Ä‘áº¹p nháº¥t cá»§a ngÃ y hÃ´m nay ğŸŒ¸"
      ];

      const E = {
        bgm: $("bgm"),
        stage1: $("stage1"), stage2: $("stage2"), stage3: $("popup"),
        stage4: $("stage4"), stage5: $("stage5"), stage6: $("stage6"),
        stage7: $("stage7"), stage8: $("stage8"),
        btnStart: $("btnStart"), btnPopupNext: $("btnPopupNext"),
        btnToBox: $("btnToBox"), btnToStage6: $("btnToStage6"),
        btnToLetter: $("btnToLetter"), btnToEnd: $("btnToEnd"),
        btnShare: $("btnShare"), btnReplay: $("btnReplay"),
        popupImg: $("popupImg"), popupText: $("popupText"),
        giftWrap: $("giftWrap"), envelope: $("envelope")
      };

      let catched = 0;
      let msgIndex = 0;
      let rainTimer = null;

      // --- Stage Controller ---
      function showStage(n) {
        const ids = [1,2,3,4,5,6,7,8];
        ids.forEach(i => {
          const node = i===3 ? E.stage3 : $("stage"+i);
          if (!node) return;
          node.classList.remove("show");
          node.classList.add("hidden");
        });
        const key = n===3 ? "stage3" : "stage"+n;
        const target = (n===3) ? E.stage3 : $(key);
        if (target) {
          target.classList.remove("hidden");
          // microtask to trigger transition
          setTimeout(() => target.classList.add("show"), 20);
        }
      }

      // --- Effects ---
      function heartBurst(x,y,count=10) {
        for (let i=0;i<count;i++){
          const h = document.createElement("div");
          h.className = "heart";
          h.textContent = "ğŸ’–";
          const a = Math.random()*Math.PI*2, d = 60+Math.random()*80;
          h.style.left = x+"px"; h.style.top = y+"px";
          h.style.setProperty("--dx", Math.cos(a)*d + "px");
          h.style.setProperty("--dy", Math.sin(a)*d + "px");
          document.body.appendChild(h);
          setTimeout(() => h.remove(), 1500);
        }
      }

      // --- Rain gifts ---
      function spawnFalling(){
        const img = document.createElement("img");
        img.src = gifts[Math.floor(Math.random()*gifts.length)];
        img.className = "falling";
        img.style.left = (Math.random()*(window.innerWidth-70))+"px";
        img.addEventListener("click", (e) => {
          img.remove();
          catched++;
          heartBurst(e.clientX, e.clientY, 10);
          showPopup();
        });
        document.body.appendChild(img);
        setTimeout(() => img.remove(), 9000);
      }
      function startRain(){
        stopRain();
        catched = 0;
        spawnFalling();
        rainTimer = setInterval(spawnFalling, 1200);
      }
      function stopRain(){
        if (rainTimer) { clearInterval(rainTimer); rainTimer = null; }
      }

      // --- Popup (Stage 3 overlay) ---
      function showPopup(){
        E.stage2.classList.add("hidden");
        showStage(3);
        E.popupImg.src = gifts[msgIndex % gifts.length];
        E.popupText.textContent = messages[msgIndex % messages.length];
        msgIndex++;
      }

      // --- Wiring ---

      // Start button (robust autoplay handling)
      E.btnStart.addEventListener("click", async () => {
        try { await E.bgm.play(); } catch { /* autoplay cÃ³ thá»ƒ bá»‹ cháº·n, bá» qua */ }
        showStage(2);
        setTimeout(startRain, 350);
      });

      // Popup -> back to 2 or forward to 4
      E.btnPopupNext.addEventListener("click", () => {
        showStage(2); // táº¯t overlay
        if (catched >= 3) {
          stopRain();
          showStage(4);
        }
      });

      // Stage 4 -> 5 -> 6
      E.btnToBox.addEventListener("click", () => showStage(5));
      E.btnToStage6.addEventListener("click", () => showStage(6));

      // Gift click (open lid + flower + glow)
      E.giftWrap.addEventListener("click", (e) => {
        const box = e.target.closest(".gift");
        if (!box) return;
        const lid = box.querySelector(".box-lid");
        if (lid) {
          lid.style.transition = "transform .4s ease";
          lid.style.transform = "translateY(-70px) rotate(-6deg)";
        }
        const rect = box.getBoundingClientRect();
        heartBurst(rect.left + rect.width/2, rect.top + rect.height/2, 14);

        const flower = document.createElement("img");
        flower.src = "./assets/bouquet.png";
        flower.className = "flower-rise";
        flower.onerror = () => {
          flower.remove();
          const fb = document.createElement("div");
          fb.textContent = "ğŸ’";
          fb.style.cssText = "position:fixed;left:50%;top:60%;transform:translate(-50%,-50%);font-size:120px;animation:flowerRise 3s ease-out forwards;z-index:100;";
          document.body.appendChild(fb);
          setTimeout(() => fb.remove(), 3000);
        };
        document.body.appendChild(flower);

        const glow = document.createElement("div");
        glow.className = "glow";
        document.body.appendChild(glow);
        setTimeout(() => glow.remove(), 3000);

        setTimeout(() => E.btnToLetter.classList.remove("hidden"), 1800);
        setTimeout(() => flower.remove(), 3200);
      });

      // Stage 6 -> 7 (love letter)
      E.btnToLetter.addEventListener("click", () => showStage(7));
      E.envelope.addEventListener("click", () => {
        E.envelope.classList.toggle("open");
      });

      // Stage 7 -> 8
      E.btnToEnd.addEventListener("click", () => showStage(8));

      // Share & Replay
      E.btnShare.addEventListener("click", async () => {
        const url = window.location.href;
        const text = "ğŸ’Œ Thiá»‡p 20/10 cá»±c xinh mÃ¬nh vá»«a nháº­n, cÃ¹ng khÃ¡m phÃ¡ nhÃ©!";
        try {
          if (navigator.share) {
            await navigator.share({ title: "Thiá»‡p 20/10", text, url });
          } else {
            await navigator.clipboard.writeText(url);
            alert("ÄÃ£ sao chÃ©p liÃªn káº¿t chia sáº»!");
          }
        } catch {
          try { await navigator.clipboard.writeText(url); alert("ÄÃ£ sao chÃ©p liÃªn káº¿t chia sáº»!"); } catch {}
        }
      });

      E.btnReplay.addEventListener("click", () => {
        msgIndex = 0;
        catched = 0;
        stopRain();
        showStage(1);
      });

      // Autoplay fallback: phÃ¡t nháº¡c láº§n cháº¡m Ä‘áº§u tiÃªn
      document.body.addEventListener("click", () => {
        if (E.bgm.paused) { E.bgm.play().catch(()=>{}); }
      }, { once: true });

      // Init
      showStage(1);
      // Sanity checks
      try{
        console.assert(typeof showStage === "function", "showStage exists");
        console.assert(Array.isArray(gifts) && gifts.length >= 3, "Need gifts images");
        console.assert(Array.isArray(messages) && messages.length >= 3, "Need messages");
      } catch {}
    });
  </script>
</body>
</html>
